📝 写在前面

从开始帮孩子准备 PK-12 私立学校申请那天起，我的浏览器就变成了“招生资料博物馆”：学校官网、Niche 排名、招生 FAQ、学费表、面试指南……标签页永远关不完。

真正让人崩溃的不是信息多，而是信息**割裂**：
- 查学校时我在看“排名/学费/招生要求”
- 写文书时我在翻“学校价值观/项目特色”
- 练面试时又要把“孩子经历”重新组织成能说出口的回答

同一个孩子的故事，要被我手动“套用”到不同学校的口味里反复改写。最耗精力的其实是机械劳动，而不是思考本身。

于是我决定做一个工具：**PK-12 Private School Application Copilot**——一个把“择校-文书-面试”串成闭环的 AI 助手，让家长从重复劳动里被解放出来。

下面分享这个项目到目前为止的真实实现路径、关键技术决策，以及和 AI/搜索/前端兼容性斗智斗勇踩过的坑。

---

🎯 核心目标：把流程做成“闭环”，让上下文不丢

我希望它解决三个连续任务：

1) **School Search（择校情报）**
- 输入 ZIP / City / State / School Name
- 快速拿到学校列表：名称、地址、网站、Niche 相关排名/评级等高层信息
- 点击某个学校再拉取“深度详情”（学费、招生、价值观、社区、升学等）

2) **Application Writer（文书生成）**
- 选择学校 + 填好学生画像
- 粘贴申请问题
- 生成**书面英文**、结构清晰、贴合学校价值观的回答草稿

3) **Interview Prep（面试训练）**
- 生成模拟面试题
- 前端录音 60 秒
- 后端转写并给出反馈（语法/相关性/表达建议），不依赖外部搜索，避免额外限流风险

---

🧱 技术架构：FastAPI 一体化服务 + 静态前端 + OpenAI-compatible 后端

为了迭代快、部署简单，我们采用了“单端口一体化”：
- **后端**：FastAPI（提供 JSON API + 静态页面服务）
- **前端**：纯 HTML/CSS/JS（由后端 `StaticFiles` 直接托管）
- **模型调用**：使用 OpenAI SDK，但指向 AI Builders 的 OpenAI-compatible Base URL（后端注入 Token，不在代码里硬编码）

这样做的好处是：本地跑起来快，部署也只需要一个服务端口，不用分离前后端。

---

🔍 School Search：从“多次调用/限流崩溃”到“两段式 + 更少请求”

### 1) 两段式搜索：先快后深
早期我们尝试“每个学校都再查一遍详情”，但非常慢，且很容易触发搜索/工具限流，导致：
- 搜索卡很久
- 详情为空
- 前端收到 HTML/非 JSON，出现 `Unexpected token '<'` 或解析错误

后来改成两段式：
- **第一步（快速列表）**：只展示高层信息（名称/地址/网站/ Niche 信息/一句话总结）
- **第二步（点击详情）**：只对用户点击的学校做深搜，补齐学费/招生/价值观等

这显著降低了请求数量，改善了“体感速度”。

### 2) 真实世界的坑：搜索限流/工具链“自动触发”
我们遇到过很典型的生产问题：外部搜索服务（例如 Tavily）因为套餐限制返回 432/502，导致整个链路失败。

应对策略经历了几轮迭代：
- **减少调用次数**：从“每校一次”改成“先列表后详情”
- **fallback 机制**：当搜索不可用时，允许用模型内部知识生成兜底（至少给 UI 一个可用结果）
- **更严格的 JSON 输出约束**：要求模型“只返回 JSON”，并在后端做强健解析

### 3) “The string did not match the expected pattern”
这是前端最常见的报错之一。根因通常不是“字符串坏了”，而是：
- 后端长时间等待导致超时/空响应
- 模型返回了非 JSON（带解释、带 markdown 代码块）
- 搜索结果太长，prompt 过大，输出被截断，JSON 不完整

我们在后端做了几件事来降概率：
- **限制输入长度**：把搜索结果截断到合理范围（避免超长 prompt）
- **更强的 JSON 提取**：去掉 markdown、用正则抓取数组/对象，再 `json.loads`
- **失败兜底**：解析失败时返回“可显示的 fallback 卡片”，前端不至于崩掉

---

📌 Watchlist + Profile：隐私优先（LocalStorage）但要可用

我们把家长最敏感的学生信息放在浏览器端：
- 学生画像（Profile）保存在 **LocalStorage**
- 关注学校（Watchlist）也在 LocalStorage

好处：
- 不需要数据库
- 降低隐私风险（不把孩子数据落在服务器）

踩坑：
- 一开始“加入 watchlist”会触发重新搜索，导致 UI 闪动、请求变多
- 后来改成只更新本地状态和按钮 UI，不重跑搜索

---

🎤 Interview Prep：录音 + 转写 + 反馈

面试模块我们做到了“能跑通”的闭环：
- 浏览器用 `MediaRecorder` 录音（限制 60 秒）
- 后端用转写接口返回文本
- 再用模型做点评（只基于“题目 + 转写文本”，不触发外部搜索，避免再次限流）

这里最大的工程点不是模型，而是：
- 浏览器权限与兼容性
- 表单上传需要 `python-multipart`
- UI 反馈要即时、要让家长看得懂

---

🖥️ 前端体验优化：闪烁/卡顿/移动端输入“锁死”

### 1) Chrome 整页闪烁（非常致命）
我们遇到过一个很离谱的问题：学校卡片 hover 后，Chrome 整个页面闪烁，甚至像显卡驱动问题一样。

排查下来最可疑的是：
- `transform` + `box-shadow` + `will-change: transform` 的组合
- DOM 替换（加载详情后替换卡片结构）触发重新合成层

最终采取的“稳”策略是：
- **移除卡片动画**（禁用 transition/transform）
- 降低 GPU 合成层抖动概率

牺牲一点动效，换取稳定性。

### 2) 移动端 Profile 很难填写（需要滚一点才可点）
这是 iOS Safari 常见坑：在 `overflow` 容器里，输入框可能出现“点不进去/像锁住”。

我们做的改进包括：
- Modal 结构改成 `flex`：header/body/footer 三段，body 独立滚动
- 使用 `overflow-y: scroll`（比 `auto` 在 iOS 上更稳定）
- 输入框 `font-size: 16px` 防止 iOS 自动放大/跳动
- 提升触控体验：padding、更大的按钮、更明确的 focus 样式

---

🤖 与 AI 协作的“真实踩坑”

1) **“只返回 JSON”并不等于真的只返回 JSON**
模型很容易在 JSON 外面加解释、加 markdown。解决方式不是“再提醒一句”，而是：
- 通过 system message 强约束
- 后端写强健解析与兜底
- 对失败情况做可视化提示，而不是让前端崩溃

2) **外部搜索不是无限可用**
你会以为“搜索 API 就是网络请求”，但现实是配额/限流/供应商不稳定都很常见。
所以我们必须设计：
- 少请求（两段式）
- 可降级（fallback）
- 可恢复（重试/提示）

3) **体验问题往往不是“换个 CSS”那么简单**
移动端输入“锁死”、Chrome 闪烁这种问题，经常是浏览器渲染/合成层/滚动容器叠加造成的。
最后只能用更稳的布局和更少的动画去解决。

---

🤝 写在最后

这个项目从最开始的“能聊一句话”到现在的“择校-文书-面试三模块雏形”，中间最大的收获不是某个模型有多强，而是：**工程化的约束、降级与体验控制**才是 AI 产品能落地的关键。

接下来我希望继续把它做得更像一个真正能用的“家长助手”：
- 更稳定的搜索与解析
- 更可靠的学校详情（学费/招生/价值观更准确）
- 更顺滑的移动端表单体验

如果你也在焦虑地准备申请，希望这个 Copilot 能帮你少开几十个标签页，少熬几次夜。

